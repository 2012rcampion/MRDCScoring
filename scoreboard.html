<html>
	<head>
		<title>Scoreboard</title>
		<link rel='stylesheet' type='text/css' href='style.css'/>
		<script src='jquery-1.11.0.js'></script>
		<script src='jquery-ui.js'></script>
		<script src='/socket.io/socket.io.js'></script>
		<script>
			socket = {};
			currentColor = -1;
			teamColors = [
				'#ff0000',
				'#ffff00',
				'#00ff00',
				'#0000ff',
				'#7f0000',
				'#7f7f00',
				'#007f00',
				'#00007f'
			];
			fieldColors = {
				't':'#ddc16f',
				'd':'#888888',
				'l':'#bbbbbb',
				'w':'#ffffff',
				'S':'#9370db',
			};
			size = 11;
			squareDim = 50; //pixels
			
			var teamData = [];
				
			$(document).ready(function() {
				socket = io.connect(location.hostname);
				
				$('#field').css({width:size*squareDim, height:size*squareDim});
				for(var i = 0; i < size; i++) {
					var row = $('<tr></tr>');
					$('#board').append(row);
					for(var j = 0; j < size; j++) {
						var cell = $('<td></td>');
						cell.data('row', i);
						cell.data('col', j);
						cell.on('click', function() {
							var x = +$(this).data('col');
							var y = +$(this).data('row');
							socket.emit('capture', {
								team:currentColor,
								row:y,
								col:x
							});
						});
						cell.css({width:squareDim, height:squareDim})
						row.append(cell);
					}
				}
				
				var teamsDiv = $('#teams');
								
				var canvas = $('canvas#canvas')[0];
				canvas.width = size*squareDim;
				canvas.height = size*squareDim;
				context = canvas.getContext('2d');
				context.fillStyle = '#444444';
				context.fillRect(0, 0, size*squareDim, size*squareDim);
				
				$('#startTimer').on('click', function() {
					socket.emit('startTimer');
				});
				
				$('#stopTimer').on('click', function() {
					socket.emit('stopTimer');
				});
				
				$('#resetTimer').on('click', function() {
					socket.emit('resetTimer');
				});
				
				$('#setTimer').on('click', function() {
					socket.emit('setTimer',$('#timerInput').val());
				});
				
				$('#resetGame').on('click', function() {
					socket.emit('resetGame');
				});
				
				$('#teamSelector').on('change', function() {
					$('#newTeamName').val('');
					$('#newTeamMultiplier').val('');
					var id = $(this).val();
					for(var i = 0; i < teamData.length; i++) {
						var t = teamData[i];
						if(t._id == id) {
							$('#newTeamName').val(t.name);
							$('#newTeamMultiplier').val(t.multiplier);
							break;
						}
					}
				});
				
				$('#modifyTeam').on('click', function() {
					if(!$('#teamSelector').val()) {
						alert('You must first select a team');
						return;
					}
					if($('#newTeamName').val() == "") {
						alert('You must enter a name for the team');
						return;
					}
					socket.emit('modifyTeam', {
						_id: $('#teamSelector').val(),
						name: $('#newTeamName').val(),
						multiplier: +($('#newTeamMultiplier').val())
					});
				});
				
				$('#removeTeam').on('click', function() {
					if(!$('#teamSelector').val()) {
						alert('You must first select a team');
						return;
					}
					socket.emit('removeTeam', $('#teamSelector').val());
				});
				
				$('#createTeam').on('click', function() {
					if($('#newTeamName').val() == "") {
						alert('You must enter a name for the team');
						return;
					}
					socket.emit('createTeam', {
						name: $('#newTeamName').val(),
						multiplier: +($('#newTeamMultiplier').val())
					});
				});
				
				$('#upcomingList').sortable({
					axis:'y', 
					update:function(event, ui) {
						var children = $(this).children();
						var ids = [];
						for(var i = 0; i < children.length; i++) {
							ids[i] = $(children[i]).data('id');
						}
						socket.emit('reorderUpcoming', ids);
					}
				});
				
				socket.on('updateState', function(data) {
					var f = data.field;
					console.log(data);
					context.clearRect(0, 0, size*squareDim, size*squareDim);
					context.lineWidth = 16;
					for(var i = 0; i < f.territories; i++) {
						var border = f.borders[i];
						context.beginPath();
						context.moveTo(border[0].x * squareDim,
							border[0].y * squareDim);
						for(var j = 1; j < border.length; j++ ) {
							context.lineTo(border[j].x * squareDim,
							border[j].y * squareDim);
						}
						context.closePath();
						
						context.fillStyle = fieldColors[f.colors[i]];
						context.fill();
						
						var color = f.state[i];
						if(color >= 0) {
							context.strokeStyle = teamColors[color];
							context.globalAlpha = 0.75;
							context.save();
							context.clip();
							context.stroke();
							context.restore();
							context.globalAlpha = 1;
						}
					}
					for(var i = 0; i < f.maxTeams; i++) {
						var x1 = f.ramps[i].start.col * squareDim;
						var y1 = f.ramps[i].start.row * squareDim;
						var x2 = f.ramps[i].end.col * squareDim;
						var y2 = f.ramps[i].end.row * squareDim;
						if(f.ramps[i].state == 'forward') {
							var x0 = x1;
							var y0 = y1;
							x1 = x2;
							y1 = y2;
							x2 = x0;
							y2 = y0;
						}
						context.beginPath();
						context.moveTo(x1, y1);
						context.lineTo(x2, y2);
						context.strokeStyle = '#222222';
						context.lineWidth = squareDim;
						context.lineCap = 'square';
						context.stroke();
						
						if(f.ramps[i].state != 'stopped') {
							context.beginPath();
							for(var j = 0; j < 3; j++) {
								context.moveTo((0.1+0.4*j)*x1+(0.9-0.4*j)*x2, (-.3+0.4*j)*y1+(1.3-0.4*j)*y2);
								context.lineTo((0.3+0.4*j)*x1+(0.7-0.4*j)*x2, (0.3+0.4*j)*y1+(0.7-0.4*j)*y2);
								context.lineTo((-.3+0.4*j)*x1+(1.3-0.4*j)*x2, (0.1+0.4*j)*y1+(0.9-0.4*j)*y2);
								context.closePath();
							}
							context.fillStyle = '#ffcc00';
							context.fill();
						}
					}
					var list = $('#teams');
					list.find('li').remove();
					for(var i = 0; i < data.teams.length; i++) {
						list.append(
							$('<li>')
							.text(teamData[data.teams[i]].name + ':')
							.append($('<span>').text(data.scores[i].score))
							.data('team', i)
							.css({'background-color': teamColors[i]})
							.on('click', function() {
								currentColor = +$(this).data('team');
								$(this).siblings().removeClass('selected');
								$(this).addClass('selected');
							})
						);
					}
				});
				
				socket.on('updateTime', function(data) {
					var m = Math.floor(data/60000);
					var s = Math.floor(data/1000)-60*m;
					$('.time').html(m+':'+('0'+s).slice(-2));
				});
				
				socket.on('updateTeams', function(data) {
					teamData = data;
					var list = $('#teamList');
					list.find('li').remove();
					var selector = $('.teamSelector');
					selector.find('option').remove();
					//selector.append($('<option>'));
					for(var i = 0; i < teamData.length; i++) {
						var t = teamData[i];
						teamData[t._id] = t;
						list.append(
							$('<li>')
							.text(t.name +
							(t.multiplier == 1 ? '' : ' (x'+t.multiplier+')'))
							.data('id', t._id)
							.on('click', function() {
								$('#teamSelector').val($(this).data('id'))
									.trigger('change');
							})
						);
						selector.append(
							$('<option>')
							.val(t._id)
							.text(t.name)
						);
					}
					selector.trigger('change');/*each(function(index, element) {
						element.trigger('change');
					});*/
				});
				
				socket.on('updateUpcoming', function(data) {
					var list = $('#upcomingList');
					list.find('li').remove();
					for(var i = 0; i < data.length; i++) {
						var u = data[i];
						var li = $('<li>').data('id', u._id);
						for(var j = 0; j < u.teams.length; j++) {
							li.append(
								$('<span>')
								.text(teamData[u.teams[j]].name)
								.addClass('upcoming')
								.append(
									$('<button>')
									.text('x')
									.data('team', u.teams[j])
									.on('click', function() {
										socket.emit('removeUpcomingTeam', {
											_id:($(this).closest('li').data('id')),
											team:($(this).data('team'))
										});
									})
								)
							);
						}
						li.append($('#teamSelector').clone());
						li.append(
							$('<button>')
							.text('Add')
							.data('id', u._id)
							.on('click', function() {
								socket.emit('addUpcomingTeam', {
									_id:($(this).parent('li').data('id')),
									team:($(this).prev('select').val())
								});
							})
						);
						list.append(li);
					}
				});
			
			});
		</script>
	</head>
	<body>
		<div id='field'>
			<table id='board'></table>
			<canvas id='canvas'></canvas>	
		</div>
		<div id='sidebar'>
			<span class='time'></span>
			<ul id='teams'>
			</ul>
			Ramp:
			<button id='startRamp'>Activate</button>
			<button id='stopRamp'>Deactivate</button><br/>
			<button id='openDoor'>Door</button>
			<button id='getCone'>Cone</button>
			<button id='dropWall'>Drop Wall</button><br/>
			<button id='personalFoul'>Personal Foul</button>
			<button id='technicalFoul'>Technical Foul</button>
		</div>
		<div id='bottom'>
			<h2>Current Game</h2>
			<span class='time'></span>
			<button id='startTimer'>Start</button>
			<button id='stopTimer'>Pause</button>
			<button id='resetTimer'>Reset</button>
			<button id='setTimer'>Set to:</button>
			<input id='timerInput'/><br/>
			
			<ul id='teams'></ul>
			<button id='resetGame'>Reset Game</button><br/>
			
			<h2>Teams</h2>
			
			<ul id='teamList'>
			</ul>
			
			<select id='teamSelector' class='teamSelector'>
			</select>
			Name: <input id='newTeamName'/>
			Multiplier: <input id='newTeamMultiplier' size=1/>
			<button id='modifyTeam'>Edit</button>
			<button id='removeTeam'>Delete</button>
			<button id='createTeam'>New Team</button>
			
			<h2>Upcoming Matches</h2>
			
			<ul id='upcomingList'>
			</ul>
		</div>
		
		<div style="border:1px dotted red;width:1022px;height:567px;position:fixed;left:0;top:0;z-index:-100;background-color:#ffffff">
	</body>
</html>
