<html>
	<head>
		<title>Scoreboard</title>
		<link rel='stylesheet' type='text/css' href='style.css'/>
		<script src='jquery-1.11.0.js'></script>
		<script src='/socket.io/socket.io.js'></script>
		<script>
			socket = io.connect(location.hostname);
			currentColor = -1;
			teamColors = [
				'#ff0000',
				'#ffff00',
				'#00ff00',
				'#0000ff',
				'#7f0000',
				'#7f7f00',
				'#007f00',
				'#00007f'
			];
			fieldColors = {
				't':'#ddc16f',
				'd':'#888888',
				'l':'#bbbbbb',
				'w':'#ffffff',
				'S':'#9370db',
			};
			size = 11;
			squareDim = 50; //pixels
			
			var teamData = [];
				
			$(document).ready(function() {
				$('#field').css({width:size*squareDim, height:size*squareDim});
				for(var i = 0; i < size; i++) {
					var row = $('<tr></tr>');
					$('#board').append(row);
					for(var j = 0; j < size; j++) {
						var cell = $('<td></td>');
						cell.data('row', i);
						cell.data('col', j);
						cell.on('click', function() {
							var x = +$(this).data('col');
							var y = +$(this).data('row');
							socket.emit('capture', {
								team:currentColor,
								row:y,
								col:x
							});
						});
						cell.css({width:squareDim, height:squareDim})
						row.append(cell);
					}
				}
				
				var teamsDiv = $('#teams');
				for(var i = 0; i < 4; i++) {
					var listItem = $('<li></li>');
					listItem.html(
						'<span class=\'name\'>Team ' + (1+i) + '</span>' + 
						': <span class=\'score\'>0</span>'
					);
					listItem.data('team', i)
					listItem.css({'background-color': teamColors[i]});
					listItem.on('click', function() {
						currentColor = +$(this).data('team');
						$(this).siblings().removeClass('selected');
						$(this).addClass('selected');
					});
					teamsDiv.append(listItem);
				}
				
				var canvas = $('canvas#canvas')[0];
				canvas.width = size*squareDim;
				canvas.height = size*squareDim;
				context = canvas.getContext('2d');
				context.fillStyle = '#444444';
				context.fillRect(0, 0, size*squareDim, size*squareDim);
				
				$('#startTimer').on('click', function() {
					socket.emit('startTimer');
				});
				
				$('#stopTimer').on('click', function() {
					socket.emit('stopTimer');
				});
				
				$('#resetTimer').on('click', function() {
					socket.emit('resetTimer');
				});
				
				$('#setTimer').on('click', function() {
					socket.emit('setTimer',$('#timerInput').val());
				});
				
				$('#resetGame').on('click', function() {
					socket.emit('resetGame');
				});
				
				$('#createTeam').on('click', function() {
					socket.emit('createTeam', {
						name: $('#newTeamName').val(),
						multiplier: +($('#newTeamMultiplier'))
					});
				});
				
				socket.on('stateUpdate', function(data) {
					var f = data.field;
					console.log(data);
					context.clearRect(0, 0, size*squareDim, size*squareDim);
					context.lineWidth = 16;
					for(var i = 0; i < f.territories; i++) {
						var border = f.borders[i];
						context.beginPath();
						context.moveTo(border[0].x * squareDim,
							border[0].y * squareDim);
						for(var j = 1; j < border.length; j++ ) {
							context.lineTo(border[j].x * squareDim,
							border[j].y * squareDim);
						}
						context.closePath();
						
						context.fillStyle = fieldColors[f.colors[i]];
						context.fill();
						
						var color = f.state[i];
						if(color >= 0) {
							context.strokeStyle = teamColors[color];
							context.save();
							context.clip();
							context.stroke();
							context.restore();
						}
					}
					for(var i = 0; i < f.teams; i++) {
						var x1 = f.ramps[i].start.col * squareDim;
						var y1 = f.ramps[i].start.row * squareDim;
						var x2 = f.ramps[i].end.col * squareDim;
						var y2 = f.ramps[i].end.row * squareDim;
						if(f.ramps[i].state == 'forward') {
							var x0 = x1;
							var y0 = y1;
							x1 = x2;
							y1 = y2;
							x2 = x0;
							y2 = y0;
						}
						context.beginPath();
						context.moveTo(x1, y1);
						context.lineTo(x2, y2);
						context.strokeStyle = '#222222';
						context.lineWidth = squareDim;
						context.lineCap = 'square';
						context.stroke();
						
						if(f.ramps[i].state != 'stopped') {
							context.beginPath();
							for(var j = 0; j < 3; j++) {
								context.moveTo((0.1+0.4*j)*x1+(0.9-0.4*j)*x2, (-.3+0.4*j)*y1+(1.3-0.4*j)*y2);
								context.lineTo((0.3+0.4*j)*x1+(0.7-0.4*j)*x2, (0.3+0.4*j)*y1+(0.7-0.4*j)*y2);
								context.lineTo((-.3+0.4*j)*x1+(1.3-0.4*j)*x2, (0.1+0.4*j)*y1+(0.9-0.4*j)*y2);
								context.closePath();
							}
							context.fillStyle = '#ffcc00';
							context.fill();
						}
					}
					var teams = $('#teams').children();
					for(var i = 0; i < teams.length; i++) {
						$(teams[i]).find('.name').html(data.teams[i].name);
						$(teams[i]).find('.score').html(data.teams[i].score);
					}
				});
				
				socket.on('timeUpdate', function(data) {
					var m = Math.floor(data/60000);
					var s = Math.floor(data/1000)-60*m;
					$('#time').html(m+':'+('0'+s).slice(-2));
				});
				
				socket.on('teamsUpdate', function(data) {
					teamData = data;
					var teamList = $('#teamList');
					teamList.find('li').remove();
					for(var i = 0; i < teamData.length; i++) {
						var t = teamData[i];
						var teamDiv = $('<li></li>');
						teamDiv.text(teamData[i].name +
							(t.multiplier == 1 ? '' : ' (x'+t.multiplier+')'));
						teamList.append(teamDiv);
					}
				});
			
			});
		</script>
	</head>
	<body>
		<div id='field'>
			<table id='board'></table>
			<canvas id='canvas'></canvas>	
		</div>
		<div id='sidebar'>
			<ul id='teams'>
			</ul>
		</div>
		<div id='bottom'>
			<h2>Current Game</h2>
			<span id='time'></span>
			<button id='startTimer'>Start</button>
			<button id='stopTimer'>Pause</button>
			<button id='resetTimer'>Reset</button>
			<button id='setTimer'>Set to:</button>
			<input id='timerInput'></input><br/>
			
			<ul id='teams'></ul>
			<button id='resetGame'>Reset Game</button><br/>
			
			<h2>Teams</h2>
			
			<ul id='teamList'>
			</ul>
			New team:<br/>
			Name: <input id='newTeamName'></input><br/>
			Multiplier: <input id='newTeamMultiplier'></input>(defaults to 1)
			<button id='createTeam'>Create Team</button>
		</div>
		
		<div style="border:1px dotted red;width:1022px;height:567px;position:fixed;left:0;top:0;z-index:-100;background-color:#ffeeff">
	</body>
</html>
