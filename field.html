<html>
	<head>
		<title>Scoreboard</title>
		<link rel='stylesheet' type='text/css' href='style-large.css'/>
		<script src='jquery-1.11.0.js'></script>
		<script src='jquery-ui.js'></script>
		<script src='/socket.io/socket.io.js'></script>
		<script>
			socket = {};
			currentColor = -1;
			teamColors = [
				'#0000ff', //regular
				'#ffff00',
				'#00ff00',
				'#ff0000',
				'#00007f',
				'#7f7f00',
				'#007f00',
				'#7f0000'
			];
			fieldColors = {
				't':'#ddc16f',
				'd':'#888888',
				'l':'#bbbbbb',
				'w':'#ffffff',
				'S':'#9370db',
			};
			size = 11;
			squareDim = 65; //pixels
			
			var teamData = [];
				
			$(document).ready(function() {
				socket = io.connect(location.hostname);
				
				$('#field').css({width:size*squareDim, height:size*squareDim});
				for(var i = 0; i < size; i++) {
					var row = $('<tr></tr>');
					$('#board').append(row);
					for(var j = 0; j < size; j++) {
						var cell = $('<td></td>');
						cell.data('row', i);
						cell.data('col', j);
						cell.on('click', function() {
							var x = +$(this).data('col');
							var y = +$(this).data('row');
							socket.emit('capture', {
								team:currentColor,
								row:y,
								col:x
							});
						});
						cell.css({width:squareDim, height:squareDim})
						row.append(cell);
					}
				}
				
				var teamsDiv = $('#teams');
								
				var canvas = $('canvas#canvas')[0];
				canvas.width = size*squareDim;
				canvas.height = size*squareDim;
				context = canvas.getContext('2d');
				context.fillStyle = '#777777';
				context.fillRect(0, 0, size*squareDim, size*squareDim);
				
				//game functions
				
				$('#pushCompleted').on('click', function() {
					socket.emit('pushCompleted');
				});
				
				$('#popUpcoming').on('click', function() {
					socket.emit('popUpcoming');
				});
				
				$('#upcomingList').sortable({
					axis:'y', 
					update:function(event, ui) {
						var children = $(this).children();
						var ids = [];
						for(var i = 0; i < children.length; i++) {
							ids[i] = $(children[i]).data('id');
						}
						socket.emit('reorderUpcoming', ids);
					}
				});
				
				socket.on('updateState', function(data) {
					var f = data.field;
					//console.log(data);
					context.clearRect(0, 0, size*squareDim, size*squareDim);
					context.lineWidth = 16;
					for(var i = 0; i < f.territories; i++) {
						var border = f.borders[i];
						context.beginPath();
						context.moveTo(border[0].x * squareDim,
							border[0].y * squareDim);
						for(var j = 1; j < border.length; j++ ) {
							context.lineTo(border[j].x * squareDim,
							border[j].y * squareDim);
						}
						context.closePath();
						
						context.fillStyle = fieldColors[f.colors[i]];
						context.fill();
						
						var color = f.state[i];
						if(color >= 0) {
							context.strokeStyle = teamColors[color];
							context.globalAlpha = 0.75;
							context.save();
							context.clip();
							context.stroke();
							context.restore();
							context.globalAlpha = 1;
						}
					}
					for(var i = 0; i < f.maxTeams; i++) {
						var x1 = f.ramps[i].start.col * squareDim;
						var y1 = f.ramps[i].start.row * squareDim;
						var x2 = f.ramps[i].end.col * squareDim;
						var y2 = f.ramps[i].end.row * squareDim;
						if(f.ramps[i].state == 'up') {
							var x0 = x1;
							var y0 = y1;
							x1 = x2;
							y1 = y2;
							x2 = x0;
							y2 = y0;
						}
						context.beginPath();
						context.moveTo(x1, y1);
						context.lineTo(x2, y2);
						context.strokeStyle = '#222222';
						context.lineWidth = squareDim;
						context.lineCap = 'square';
						context.stroke();
						
						if(f.ramps[i].visible) {
							context.beginPath();
							for(var j = 0; j < 3; j++) {
								context.moveTo((0.1+0.4*j)*x1+(0.9-0.4*j)*x2, (-.3+0.4*j)*y1+(1.3-0.4*j)*y2);
								context.lineTo((0.3+0.4*j)*x1+(0.7-0.4*j)*x2, (0.3+0.4*j)*y1+(0.7-0.4*j)*y2);
								context.lineTo((-.3+0.4*j)*x1+(1.3-0.4*j)*x2, (0.1+0.4*j)*y1+(0.9-0.4*j)*y2);
								context.closePath();
							}
							context.fillStyle = '#ffcc00';
							context.fill();
						}
					}
					var list = $('#teams');
					list.find('li').remove();
					for(var i = 0; i < data.teams.length; i++) {
						var li = $('<button>')
							.text(data.teams[i].name + ':')
							.append($('<span>').text(
								data.scores[i].offsetScore +
								data.scores[i].baseScore *
								data.teams[i].multiplier
							))
							.data('team', i)
							.on('click', function() {
								currentColor = +$(this).data('team');
								$('#teams button').removeClass('selected');
								$(this).addClass('selected');
							});
						if(i == currentColor) {
							li.trigger('click');
						}
						list.append(
							$('<li>')
							.css('border-color', teamColors[i])
							.css('background-color', teamColors[i])
							.append(li)
						);
					}
				});
				
				socket.on('updateTeams', function(data) {
					teamData = data;
				});
				
				socket.on('updateTime', function(data) {
					var m = Math.floor(data/60000);
					var s = Math.floor(data/1000)-60*m;
					$('.time').html(m+':'+('0'+s).slice(-2));
				});
				
			});
		</script>
	</head>
	<body>
		<div id='field'>
			<table id='board'></table>
			<canvas id='canvas'></canvas>	
		</div>
		<div id='sidebar'>
			<div class='time' ></div>
			<ul id='teams' >
			</ul>
		</div>
	</body>
</html>
